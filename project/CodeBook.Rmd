---
title: "CodeBook"
output: html_document
---

##About BRFSS 
The [Behavioral Risk Factor Surveillance System (BRFSS)](http://www.cdc.gov/brfss/annual_data/2013/pdf/Overview_2013.pdf) is a collaborative project between all of the states in the United States (US) and participating US territories and the Centers for Disease Control and Prevention (CDC).  The BRFSS was initiated in 1984, with 15 states collecting surveillance data on risk behaviors through monthly telephone interviews. Over time, the number of states participating in the survey increased; by 2001, 50 states, the District of Columbia, Puerto Rico, Guam, and the US Virgin Islands were participating in the BRFSS.  Today, all 50 states, the District of Columbia, Puerto Rico, and Guam collect data annually and American Samoa, Federated States of Micronesia, and Palau collect survey data over a limited point- in-time (usually one to three months). 

The BRFSS objective is to collect uniform, state-specific data on preventive health practices and risk behaviors that are linked to chronic diseases, injuries, and preventable infectious diseases that affect the adult population. 

Sample Description In a telephone survey such as the BRFSS, a sample record is one telephone number in the list of all telephone numbers the system randomly selects for dialing. To meet the BRFSS standard for the participating states' sample designs, one must be able to justify sample records as a probability sample of all households with telephones in the state. All participating areas met this criterion in 2013. Fifty-one projects used a disproportionate stratified sample (DSS) design for their landline samples. Guam and Puerto Rico used a simple random-sample design. 

##Get Data 

Let's first get the data.  The original data set was provided by Coursera/Duke.  The data was saved tot eh data folder in the working directory for this project.

I have saved the data in a

```{r getRawdata}
setwd("~/GitHub/IntroToProbability/project")

if(!exists("brfss2013")) load("./data/brfss2013.RData")
class(brfss2013)
```

Some [important notes](http://www.cdc.gov/brfss/annual_data/2013/pdf/CODEBOOK13_LLCP.pdf) about the data:

- All missing values are coded NA in the R Workspace.
- Many variables, such as age, race, education, as well as variables that measure counts of events (drinks, times eating fruit, etc.) have alternate versions in the Calculated Variables section of the dataset. Review this section prior to choosing variables for analysis.

Let's get only the data we need.  I know I want to look at data between the US States and the US Territories.

The BRFSS was initiated in 1984, with 15 states collecting surveillance data on risk behaviors through monthly telephone interviews. Over time, the number of states participating in the survey increased; by 2001, 50 states, the District of Columbia, Puerto Rico, Guam, and the US Virgin Islands were participating in the BRFSS. Today, all 50 states, the District of Columbia, **Puerto Rico**, and **Guam** collect data annually and American Samoa, Federated States of Micronesia, and Palau collect survey data over a limited point- in-time (usually one to three months). 

In the data, we know:  _state: State Fips Code:

_state (66) = Guam
_state (72) = Puerto Rico
For fun:
_state (37) = North Carolina

Can also compare by year:

Inverview Year (iyear):
iyear (2013) = 2013
iyear (2014) = 2014

Let's add a new column to the data (like we more than the 330 we already have) to identify if the observation is from a US State, i.e., not either Puerto Rico or Guam.

```{r addUScolumn}
library(dplyr)
#Before assigning a new column for US State v Not US State, let's make sure the state data looks clean:
unique(brfss2013$X_state)
#Looks like X_state values of 0 and 80 do not make sense.  Le'ts make sure
#Need to remove X_state 0 and 80
modData <- filter(brfss2013, !X_state == "80"); modData <- filter(modData, !X_state == "0")
unique(modData$X_state)
modData <- modData %>% mutate(isState = ifelse(X_state %in% !c(66, 72), "US", "notUS"))
```

States looks OK.  Now lets get the columns I am interested in - behavorial health
iyear: Interview Year
nummen: Number Of Adult Men In Household
numwomen: Number Of Adult Women In Household
genhlth: General Health
physhlth: Number Of Days Physical Health Not Good
menthlth: Number Of Days Mental Health Not Good
poorhlth: Poor Physical Or Mental Health
sleptim1: How Much Time Do You Sleep
addepev2: Ever Told You Had A Depressive Disorder
educa: Education Level
weight2: Reported Weight In Pounds
exerany2: Exercise In Past 30 Days
exract11: Type Of Physical Activity
exeroft1: How Many Times Walking, Running, Jogging, Or Swimming
exerhmm1: Minutes Or Hours Walking, Running, Jogging, Or Swimming
strength: How Many Times Did You Do Physical Activities Or Exercises To Strengthen Your Mu
qlmentl2: How Many Days Depressed In Past 30 Days
qlstres2: How Many Days Felt Anxious In Past 30 Days
qlhlth2: How Many Days Full Of Energy In Past 30 Days

```{r getVariables}
variablesIwant <- c("X_state", "iyear", "nummen", "numwomen", "genhlth", "physhlth", "menthlth", "poorhlth", "sleptim1", "addepev2", "educa", "weight2", "exerany2", "exract11", "exeroft1", "exerhmm1", "strength", "qlmentl2", "qlstres2", "qlhlth2")

modData <- select(modData,one_of(variablesIwant))#new option for me in dplyr - useful
rm(brfss2013); rm(variablesIwant)
```

```{r reName}
#Rename with dplyr
modData <- rename(modData,  US_State = X_state, Year = iyear, Number_Men = nummen, Number_Women = numwomen, General_Health = genhlth, Phys_Not_OK =  physhlth, Mental_Not_OK = menthlth, Poor_Mental_or_Phys = poorhlth, Sleep_Hrs = sleptim1, Drepess_Disorder = addepev2, Education = educa, Weight = weight2, Exercise_Past30 = exerany2, Exercise_Type = exract11, Excercise_Count = exeroft1, Exercise_Time = exerhmm1,  Muscle = strength, Days_Depressed = qlmentl2, Days_Anxious = qlstres2, Full_Energy = qlhlth2)
```
Usually a safe maximum threshold is 5% of the total for large datasets. If missing data for a certain feature or sample is more than 5% then you probably should leave that feature or sample out. We therefore check for features (columns) and samples (rows) where more than 5% of the data is missing using a simple function

```{r missingData}
pMiss <- function(x){sum(is.na(x))/length(x)*100}
format(apply(modData, 2, pMiss), scientific=FALSE, digits=2)#2 mneans apply over columns
```

Let's try visualizing the missging data

Method 1:
```{r}
library(cutoffR)
#How many NA are there in the working data?
nmissing(modData)
#HeatStruct is interesting but only works with numeric variables
HeatStruct(modData)
```
Method 2:
See http://www.r-bloggers.com/imputing-missing-data-with-r-mice-package/

```{r}
library(mice)
md.pattern(modData)#works but returns too much data

#Prmising solution but a problem loading the VIM package
#To vercome the problem with have the wrong version on nlme, use this (download nlme ZIP first)
#install.packages("C:\\Users\\cweaver\\Desktop\\nlme\\nlme", repos = NULL, type="source")
#much easier to do this:  RStudio -> Tools -> Install Packages -> Install from 'Package Archive File'  See https://rpubs.com/Felix/15529
#Need to eval.  See https://cran.r-project.org/web/packages/VIMGUI/vignettes/VIM-EU-SILC.pdf
#
library(VIM)
aggr_plot <- aggr(modData, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(modData), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))
#Now try using this tool
library(VIMGUI)#See https://cran.r-project.org/web/packages/VIMGUI/vignettes/VIM-EU-SILC.pdf
vmGUImenu()

```

```{r countNA}
countNAs <- apply(modData, 2, function(x) sum(is.na(x)))
barplot(countNAs)
```

```{r}
countNAs_df <- as.data.frame(countNAs)
countNAs_df$cat <- row.names(countNAs_df)
```

Now lets make a plot that looks better
```{r}
library(ggplot2)
library(scales)
plot2 <- ggplot(countNAs_df, aes(x = reorder(Cat, -countNAs), y = countNAs)) +
  geom_bar(stat = "identity")
plot2

plot3 <- ggplot(countNAs_df, aes(x = reorder(Cat, -countNAs), y = countNAs)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle=90))
plot3

plot4 <- ggplot(countNAs_df, aes(x = reorder(cat, -countNAs), y = countNAs)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle=90)) +
  scale_y_continuous(labels = comma)
plot4

plot5 <- ggplot(countNAs_df, aes(x = reorder(cat, -countNAs), y = countNAs), 
                ylab("NA Count"), xlab("Variable Name")) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle=90)) +
  scale_y_continuous(labels = comma) +
  xlab("Variable Names") + ylab("NA Count") + ggtitle("Count of NAs in Data")
  
plot5
```


